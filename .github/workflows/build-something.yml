name: 'Build and deploy app :)'
on:
  push:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.100'
      - name: build
        uses: ./.github/actions/build-app
        with:
          build-number: ${{github.run_number}}
      - name: publish artifacts
        run: dotnet publish --no-restore --no-build --configuration Release --output artifacts/backend src/devschool-ci-test.csproj

  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.100'
      - name: Run tests
        run: dotnet test

  deploy:
    needs: [build,tests]
    if: ${{ github.ref == 'refs/heads/main' }}
    uses: ./.github/workflows/deploy-app.yml
    with:
      image_number: ${{ github.run_number }}
    secrets: inherit

  send-notification:
    name: Send notification
    runs-on: ubuntu-latest
    needs:
      - build
      - tests
    if: always()
    env:
      SLACK_FOOTER: ''
      SLACK_ICON: ${{ github.event.sender.avatar_url }}
      SLACK_WEBHOOK: ${{ secrets.LOOP_WEBHOOK }}
      SLACK_CHANNEL: devschool-test-notifications
      MSG_MINIMAL: actions url,commit
    steps:
      - name: build success
        if: ${{ needs.build.result == 'success'}}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_USERNAME: ${{ format('trubitcin homework - {0}', github.workflow) }}
          SLACK_COLOR: success
          SLACK_MESSAGE: |
            ${{ format('build: {0} done', github.run_number) }} 

